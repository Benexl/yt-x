#!/usr/bin/env bash
# A script written by Benexl in September 2024 under MIT LICENSE

CLI_ASCII_ART="\
██╗░░░██╗████████╗░░░░░░██╗░░██╗
╚██╗░██╔╝╚══██╔══╝░░░░░░╚██╗██╔╝
░╚████╔╝░░░░██║░░░█████╗░╚███╔╝░
░░╚██╔╝░░░░░██║░░░╚════╝░██╔██╗░
░░░██║░░░░░░██║░░░░░░░░░██╔╝╚██╗
░░░╚═╝░░░░░░╚═╝░░░░░░░░░╚═╝░░╚═╝
"
# ---------------------------------------------
# CLI: General Information
# ---------------------------------------------
CLI_NAME="${YT_X_APP_NAME:-yt-x}"
CLI_VERSION="1.0.0"
CLI_DESCRIPTION="A command-line tool for browsing and streaming YouTube videos using yt-dlp and mpv."
CLI_AUTHOR="Benexl"
CLI_LICENSE="MIT"
CLI_REPO_HOME="https://github.com/benexl/yt-x"

# ---------------------------------------------
# CLI: Environment Constants
# ---------------------------------------------
case "$(uname -a)" in
*ndroid) CLI_PLATFORM="android" ;;
*Darwin*) CLI_PLATFORM="mac" ;;
*MINGW* | *WSL2*) CLI_PLATFORM="windows" ;;
*) CLI_PLATFORM="linux" ;;
esac

# ---------------------------------------------
# CLI: Directories
# ---------------------------------------------
: ${CLI_CONFIG_DIR:="${XDG_CONFIG_HOME:-$HOME/.config}/$CLI_NAME"}
: ${CLI_CUSTOM_PLAYLISTS_DIR:="${XDG_CONFIG_HOME:-$HOME/.config}/$CLI_NAME/custom-playlists"}
: ${CLI_DATA_DIR:="${XDG_DATA_HOME:-$HOME/.local/share}/$CLI_NAME"}
: ${CLI_EXTENSIONS_DIR:="$CLI_DATA_DIR/extensions"}
: ${CLI_DEFAULT_EXTENSION_DIR:="$CLI_EXTENSIONS_DIR/DEFAULT"}
: ${CLI_CACHE_DIR:="${XDG_CACHE_HOME:-$HOME/.cache}/$CLI_NAME"}
: ${CLI_LOG_DIR:="$CLI_DATA_DIR/logs"}
: ${CLI_TEMP_DIR:="/tmp/$CLI_NAME"}
: ${CLI_PREVIEW_IMAGES_CACHE_DIR:="${CLI_CACHE_DIR}/preview-images"}
: ${CLI_PREVIEW_SCRIPTS_CACHE_DIR:="${CLI_CACHE_DIR}/preview-scripts"}
: ${CLI_MIXES_CACHE_DIR:="${CLI_CACHE_DIR}/mixes"}

# Create necessary directories if they don't exist
[ ! -d "$CLI_CONFIG_DIR" ] && mkdir -p "$CLI_CONFIG_DIR"
[ ! -d "$CLI_CUSTOM_PLAYLISTS_DIR" ] && mkdir -p "$CLI_CUSTOM_PLAYLISTS_DIR"
[ ! -d "$CLI_EXTENSIONS_DIR" ] && mkdir -p "$CLI_EXTENSIONS_DIR"
[ ! -d "$CLI_DEFAULT_EXTENSION_DIR" ] && mkdir -p "$CLI_DEFAULT_EXTENSION_DIR"
[ ! -d "$CLI_CACHE_DIR" ] && mkdir -p "$CLI_CACHE_DIR"
[ ! -d "$CLI_PREVIEW_IMAGES_CACHE_DIR" ] && mkdir -p "$CLI_PREVIEW_IMAGES_CACHE_DIR"
[ ! -d "$CLI_PREVIEW_SCRIPTS_DIR" ] && mkdir -p "$CLI_PREVIEW_SCRIPTS_DIR"
[ ! -d "$CLI_RUNTIME_PLAYLISTS_CACHE_DIR" ] && mkdir -p "$CLI_RUNTIME_PLAYLISTS_CACHE_DIR"
[ ! -d "$CLI_TEMP_DIR" ] && mkdir -p "$CLI_TEMP_DIR"
[ ! -d "$CLI_LOG_DIR" ] && mkdir -p "$CLI_LOG_DIR"

# ---------------------------------------------
# CLI: Files
# ---------------------------------------------
CLI_CONFIG_FILE="$CLI_CONFIG_DIR/$CLI_NAME.conf"
CLI_RECENT_FILE="$CLI_CONFIG_DIR/recent.json"
CLI_SEARCH_HISTORY_FILE="$CLI_CONFIG_DIR/search-history"
CLI_EXTENSIONS_INDEX_FILE="$CLI_CONFIG_DIR/extensions.json"
CLI_LOG_FILE="$CLI_LOG_DIR/$CLI_NAME.log"
CLI_UPDATE_CHECK_FILE="$CLI_CACHE_DIR/.last-update-check"

# ---------------------------------------------
# CLI: Other Constants
# ---------------------------------------------
CLI_INFO="info"
CLI_SUCCESS="success"
CLI_WARNING="warning"
CLI_ERROR="error"

# ---------------------------------------------
# COLORS
# ---------------------------------------------
if [ $COLOR_TERM = "truecolor" ] || [ $COLORTERM = "24bit" ]; then
  COLOR_RED="\e[38;2;255;0;0m"
  COLOR_GREEN="\e[38;2;0;255;0m"
  COLOR_YELLOW="\e[38;2;255;255;0m"
  COLOR_BLUE="\e[38;2;0;0;255m"
  COLOR_RESET="\e[0m"
else
  COLOR_RED="\e[31m"
  COLOR_GREEN="\e[32m"
  COLOR_YELLOW="\e[33m"
  COLOR_BLUE="\e[34m"
  COLOR_RESET="\e[0m"
fi

# ---------------------------------------------
# DEFAULT CONFIGURATION VALUES
# ---------------------------------------------
_CONFIG_ASCII_ART="$CLI_ASCII_ART"
_CONFIG_AUTO_LOADED_EXTENSIONS=""
_CONFIG_PRETTY_PRINT="true"
_CONFIG_SELECTOR="fzf"
_CONFIG_VIDEO_QUALITY="best"
_CONFIG_PREVIEW="none"
_CONFIG_DISOWN_STREAMING_PROCESS="false"
_CONFIG_UPDATE_RECENT="true"
_CONFIG_SEARCH_HISTORY="true"
_CONFIG_NO_OF_RECENT=25
_CONFIG_PLAYER="mpv"
_CONFIG_BROWSER=""
_CONFIG_NO_OF_SEARCH_RESULTS=5
_CONFIG_NOTIFICATION_DURATION=5
_CONFIG_DOWNLOADS_DIR="${XDG_VIDEOS_DIR:-"$HOME/Videos"}/$CLI_NAME"
_CONFIG_UPDATE_CHECK="true"
_CONFIG_FZF_OPTS="https://raw.githubusercontent.com/Benexl/yt-x/refs/heads/v1.0.0/assets/defaults/fzf-opts"
_CONFIG_ROFI_THEME_MAIN="https://raw.githubusercontent.com/Benexl/yt-x/refs/heads/v1.0.0/assets/defaults/rofi-themes/main.rasi"
_CONFIG_ROFI_THEME_PREVIEW="https://raw.githubusercontent.com/Benexl/yt-x/refs/heads/v1.0.0/assets/defaults/rofi-themes/preview.rasi"
_CONFIG_ROFI_THEME_PROMPT="https://raw.githubusercontent.com/Benexl/yt-x/refs/heads/v1.0.0/assets/defaults/rofi-themes/prompt.rasi"
_CONFIG_ROFI_THEME_CONFIRM="https://raw.githubusercontent.com/Benexl/yt-x/refs/heads/v1.0.0/assets/defaults/rofi-themes/confirm.rasi"

# environment dependant
_CONFIG_EDITOR="${EDITOR:-"vim"}"
_CONFIG_IMAGE_RENDERER=""
command -v viu >/dev/null 2>&1 && _CONFIG_IMAGE_RENDERER="viu"
command -v chafa >/dev/null 2>&1 && _CONFIG_IMAGE_RENDERER="chafa"
command -v icat >/dev/null 2>&1 && _CONFIG_IMAGE_RENDERER="icat"

_prompt() {
  #TODO: Reintergrate history support
  if command -v gum; then
    gum input --header "${CONFIG_ASCII_ART:-$CLI_ASCII_ART}" --prompt "$1"
  else
    echo "$CLI_HEADER" >/dev/stderr
    printf "%s: " "$1" >/dev/stderr
    read -r VAL
    echo "$VAL"
  fi
}

_print_config() {

  echo "\
# ===================================================================================
$(echo "$CLI_ASCII_ART" | sed 's/^/# /')
# ===================================================================================

# loads the extension always
# useful for defining changes and overides to the default behaviour
# eg env,ui,functions
# all file names in the extensions folder
AUTO_LOADED_EXTENSIONS='$AUTO_LOADED_EXTENSIONS'

# whether to show colors when printing ouput
PRETTY_PRINT='$PRETTY_PRINT'

# your preferred editor for editing your config
EDITOR='$PREFERRED_EDITOR'

# your preferred selector for the tui [fzf/rofi]
PREFERRED_SELECTOR='$PREFERRED_SELECTOR'

# the quality of the video when streaming with a player other than mpv
VIDEO_QUALITY='$VIDEO_QUALITY'

# whether to show previews [true/false]
# its cool so enable it
ENABLE_PREVIEW='$ENABLE_PREVIEW'

# what to use for rendering images in the terminal [chafa/icat]
IMAGE_RENDERER='$IMAGE_RENDERER'

# whether to run mpv as a background process and prevent it from closing even if you terminate the program or terminal session
DISOWN_STREAMING_PROCESS='$DISOWN_STREAMING_PROCESS'

# whether to update the recent list kept locally [true/false]
UPDATE_RECENT='$UPDATE_RECENT'

# whether to update the recent list kept locally [true/false]
SEARCH_HISTORY='$SEARCH_HISTORY'

# the number of recent videos to keep
NO_OF_RECENT='$NO_OF_RECENT'

# the player to use for streaming [mpv/vlc]
PLAYER='$PLAYER'

# the browser to use to extract cookies from
# this is used to by yt-dlp to access content that would require login
PREFERRED_BROWSER='$PREFERRED_BROWSER'

# the number of results to get from yt-dlp
NO_OF_SEARCH_RESULTS='$NO_OF_SEARCH_RESULTS'

# the duration notifications stay on the screen
NOTIFICATION_DURATION='$NOTIFICATION_DURATION'

# where your downloads will be stored
DOWNLOAD_DIRECTORY='$DOWNLOAD_DIRECTORY'

# whether to check for updates [true/false]
UPDATE_CHECK='$UPDATE_CHECK'
"
}

_setup_config() {
  # TODO: setup interactive config

  # use defaults
  _print_config

}
_load_config() {
  local config_file="$CLI_CONFIG_DIR/${CLI_NAME}.conf"

  # Ensure the config file exists before trying to read it
  [ -f "$config_file" ] || _setup_config

  # Read the config file once and export its variables
  while IFS='=' read -r key value; do
    # Skip comments and empty lines
    case "$key" in
    '' | '#'*) continue ;;
    esac

    # Ensure the key is a valid shell variable name to avoid arbitrary code execution
    # This regex allows for names like 'PRETTY_PRINT', 'NO_OF_RESULTS_2', etc.
    if ! [[ $key =~ ^[a-zA-Z_][a-zA-Z0-9_]*$ ]]; then
      # Optionally, print a warning for invalid keys
      # echo "Warning: Invalid key in config file: $key" >&2
      continue
    fi

    # Trim leading/trailing whitespace from the value and remove quotes
    # This is a robust way to clean the value without multiple external calls
    value_cleaned=$(echo "$value" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//' -e "s/^'//" -e "s/'$//" -e 's/^"//' -e 's/"$//')

    # Export the variable so it's set in the current shell's environment
    export "$key"="$value_cleaned"

  done <"$config_file"

  # --- Set configuration variables with defaults ---
  # Use POSIX parameter expansion: ${VAR:-default}
  # This assigns the default value only if the variable is unset or null.
  PRETTY_PRINT="${PRETTY_PRINT:-true}"
  IMAGE_RENDERER="${IMAGE_RENDERER:-$([ -n "$KITTY_WINDOW_ID" ] && echo "icat" || echo "chafa")}"
  DISOWN_STREAMING_PROCESS="${DISOWN_STREAMING_PROCESS:-true}"
  PREFERRED_EDITOR="${EDITOR:-${PREFERRED_EDITOR:-open}}" # Note: Prioritizes existing EDITOR env var
  PREFERRED_SELECTOR="${PREFERRED_SELECTOR:-fzf}"
  VIDEO_QUALITY="${VIDEO_QUALITY:-1080}"
  ENABLE_PREVIEW="${ENABLE_PREVIEW:-false}"
  UPDATE_RECENT="${UPDATE_RECENT:-true}"
  NO_OF_RECENT="${NO_OF_RECENT:-30}"
  PLAYER="${PLAYER:-mpv}"

  # Special handling for PREFERRED_BROWSER
  [ -n "$PREFERRED_BROWSER" ] && PREFERRED_BROWSER="--cookies-from-browser $PREFERRED_BROWSER"

  NO_OF_SEARCH_RESULTS="${NO_OF_SEARCH_RESULTS:-30}"
  NOTIFICATION_DURATION="${NOTIFICATION_DURATION:-5}"
  SEARCH_HISTORY="${SEARCH_HISTORY:-true}"

  # Special handling for DOWNLOAD_DIRECTORY
  DOWNLOAD_DIRECTORY=${DOWNLOAD_DIRECTORY/#\~/${HOME}}     # expand ~
  DOWNLOAD_DIRECTORY=${DOWNLOAD_DIRECTORY/#\$HOME/${HOME}} # expand $HOME
  [ -z "$DOWNLOAD_DIRECTORY" ] && DOWNLOAD_DIRECTORY="${XDG_VIDEOS_DIR:-"$HOME"/Videos}/$CLI_NAME"
  [ ! -d "$DOWNLOAD_DIRECTORY" ] && mkdir -p "$DOWNLOAD_DIRECTORY"

  UPDATE_CHECK="${UPDATE_CHECK:-true}"
  # ROFI_THEME has no default, so it will be empty if not in the config
  ROFI_THEME="${ROFI_THEME:-}"

  # --- The rest of your script remains the same ---
  CUSTOM_PLAYLISTS="$CLI_CONFIG_DIR/custom_playlists.json"
  F_CUSTOM_CMDS="$CLI_CONFIG_DIR/custom_cmds.json"
  F_SUBSCRIPTIONS="$CLI_CONFIG_DIR/subscriptions.json"
  PLAYLIST_START="1"
  PLAYLIST_END="$NO_OF_SEARCH_RESULTS"

  FZF_DEFAULT_OPTS=${YT_X_FZF_OPTS:-'
    --color=fg:#d0d0d0,fg+:#d0d0d0,bg:#121212,bg+:#262626
    --color=hl:#5f87af,hl+:#5fd7ff,info:#afaf87,marker:#87ff00
    --color=prompt:#d7005f,spinner:#af5fff,pointer:#af5fff,header:#87afaf
    --color=border:#262626,label:#aeaeae,query:#d9d9d9
    --border="rounded" --border-label="" --preview-window="border-rounded" --prompt="> "
    --marker=">" --pointer="◆" --separator="─" --scrollbar="│"
  '}
  init_pretty_print

  if [ -n "$AUTO_LOADED_EXTENSIONS" ]; then
    for ext in $(echo "$AUTO_LOADED_EXTENSIONS" | tr ',' '\n'); do
      [ -s "$CLI_EXTENSION_DIR/$ext" ] && . "$CLI_EXTENSION_DIR/$ext"
    done
  fi

  if ! [ -s "$config_file" ]; then
    print_config >"$config_file"
  fi

  # You may not need to export again here if you already did in the loop,
  # but it doesn't hurt to be explicit for clarity.
  export FZF_DEFAULT_OPTS PRETTY_PRINT PLATFORM IMAGE_RENDERER
}

if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
  main
fi

# MIT License
#
# Copyright (c) 2024 Benexl
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.
